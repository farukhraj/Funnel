<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Funnel Management App</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f8f8f8; padding:10px; }
h1 { text-align:center; margin-bottom:20px; font-size:22px; }
.tabs { display:flex; background:#4CAF50; margin-bottom:10px; border-radius:10px; overflow:hidden; }
.tabs button { flex:1; padding:15px; color:white; border:none; cursor:pointer; font-size:16px; }
.tabs button:hover { background:#45a049; }
.tabs button.active { background:#3e8e41; }
.tab-content { display:none; padding:10px; }
.dashboard-card { background:white; padding:15px; margin-bottom:10px; border-radius:10px; text-align:center; font-size:16px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
table { width:100%; border-collapse:collapse; background:white; margin-bottom:20px; font-size:14px; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#f2f2f2; }
table tbody tr:nth-child(even){background:#f9f9f9;}
input, select, button, textarea { width:100%; padding:12px; margin-bottom:10px; box-sizing:border-box; font-size:16px; border-radius:6px; border:1px solid #ccc;}
button { background:#4CAF50; color:white; border:none; cursor:pointer; font-weight:bold; }
button:hover { background:#45a049; }
.modal { position:fixed; top:0; left:0; width:100%; height:100%; 
         background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:100; }
.modal-content { background:white; padding:20px; border-radius:10px; width:95%; max-width:500px; max-height:95%; overflow:auto; box-shadow:0 2px 10px rgba(0,0,0,0.3);}
.close { float:right; cursor:pointer; font-weight:bold; font-size:22px; }

@media screen and (max-width:600px){
  .tabs button { font-size:14px; padding:12px; }
  .dashboard-card { font-size:14px; padding:10px; }
  table, thead, tbody, th, td, tr { display:block; width:100%; }
  thead { display:none; }
  tbody tr { margin-bottom:10px; border:1px solid #ddd; border-radius:10px; padding:10px; background:white; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
  tbody td { display:block; text-align:left; padding:5px 10px; position:relative; font-size:14px; }
  tbody td::before { content: attr(data-label); font-weight:bold; display:inline-block; width:120px; }
  tbody td button { margin-top:8px; width:100%; }
  input, select, textarea, button { font-size:16px; padding:10px; }
  .modal-content { width:98%; height:98%; padding:15px; }
}
</style>
</head>
<body>

<h1>Funnel Management App</h1>

<div class="tabs">
  <button class="tab-btn active" data-tab="dashboardTab">Dashboard</button>
  <button class="tab-btn" data-tab="salesLeadsTab">Sales Leads</button>
  <button class="tab-btn" data-tab="addClientTab">Add Client</button>
</div>

<div id="dashboardTab" class="tab-content" style="display:block;">
  <h2>Dashboard</h2>
  <div class="dashboard-card">Total Clients: <span id="totalClients">0</span></div>
</div>

<div id="salesLeadsTab" class="tab-content">
  <h2>Sales Leads</h2>
  <table>
    <thead>
      <tr><th>Name</th><th>Stage</th><th>Phones</th><th>Services</th><th>Actions</th></tr>
    </thead>
    <tbody id="clientsTable"></tbody>
  </table>
</div>

<div id="addClientTab" class="tab-content">
  <h2>Add Client</h2>
  <form id="addClientForm">
    <input type="text" id="clientName" placeholder="Name" required>
    <input type="text" id="clientPhone1" placeholder="Phone 1">
    <input type="text" id="clientPhone2" placeholder="Phone 2 (optional)">
    <input type="text" id="clientStage" placeholder="Stage">
    <input type="text" id="clientCountry" placeholder="Country">
    <input type="text" id="clientService" placeholder="Service">
    <input type="number" id="clientPrice" placeholder="Estimated Price">
    <button type="submit">Add Client</button>
  </form>
</div>

<!-- Interactions Modal -->
<div id="interactionModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>Interactions for <span id="modalClientName"></span></h2>
    <form id="addInteractionForm">
      <select id="interactionType" required>
        <option value="">-- Type --</option>
        <option value="Call">Call</option>
        <option value="Message">Message</option>
        <option value="Meeting">Meeting</option>
      </select>
      <input type="text" id="interactionPhone" placeholder="Phone Used">
      <textarea id="interactionNotes" placeholder="Notes"></textarea>
      <button type="submit">Add Interaction</button>
    </form>
    <table>
      <thead>
        <tr><th>Date</th><th>Type</th><th>Phone</th><th>Notes</th></tr>
      </thead>
      <tbody id="interactionsTable"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCC26AlX5xVRo_s0nDI1Ua26JbWh2d1FKk",
  authDomain: "leads-to-funnel.firebaseapp.com",
  projectId: "leads-to-funnel",
  storageBucket: "leads-to-funnel.firebasestorage.app",
  messagingSenderId: "574308221054",
  appId: "1:574308221054:web:9a27e9b1e8e8c0270d982f",
  measurementId: "G-2M5P17GZZJ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentClientId = null;

const clientsTable = document.getElementById("clientsTable");
const addClientForm = document.getElementById("addClientForm");
const interactionModal = document.getElementById("interactionModal");
const modalClientName = document.getElementById("modalClientName");
const addInteractionForm = document.getElementById("addInteractionForm");
const interactionsTable = document.getElementById("interactionsTable");

// Tabs
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".tab-content").forEach(c=>c.style.display="none");
    document.getElementById(btn.dataset.tab).style.display="block";
  });
});

async function loadClients(){
  clientsTable.innerHTML="";
  const snapshot = await getDocs(collection(db,"clients"));
  document.getElementById("totalClients").innerText = snapshot.size;
  snapshot.forEach(docSnap=>{
    const c = docSnap.data();
    const phones = c.phones?.join(", ")||"N/A";
    const services = c.interestedServices?.map(s=>`${s.primary} (${s.sub}) $${s.estimatedPrice}`).join(", ")||"";
    clientsTable.innerHTML += `
      <tr>
        <td data-label="Name">${c.name}</td>
        <td data-label="Stage">${c.stage}</td>
        <td data-label="Phones">${phones}</td>
        <td data-label="Services">${services}</td>
        <td data-label="Actions">
          <button onclick="openInteractions('${docSnap.id}','${c.name}')">View Interactions</button>
        </td>
      </tr>
    `;
  });
}

// Add client
addClientForm.addEventListener("submit", async e=>{
  e.preventDefault();
  await addDoc(collection(db,"clients"),{
    name: document.getElementById("clientName").value,
    phones: [document.getElementById("clientPhone1").value, document.getElementById("clientPhone2").value].filter(Boolean),
    stage: document.getElementById("clientStage").value,
    interestedServices:[{
      primary: document.getElementById("clientCountry").value,
      sub: document.getElementById("clientService").value,
      estimatedPrice: parseFloat(document.getElementById("clientPrice").value)
    }],
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  });
  addClientForm.reset();
  loadClients();
  alert("Client added!");
});

// Interactions modal
window.openInteractions = async function(clientId, clientName){
  currentClientId = clientId;
  modalClientName.innerText = clientName;
  interactionModal.style.display="flex";
  loadInteractions();
}
window.closeModal = ()=>interactionModal.style.display="none";

async function loadInteractions(){
  interactionsTable.innerHTML="";
  if(!currentClientId) return;
  const snapshot = await getDocs(collection(db,"clients",currentClientId,"interactions"));
  snapshot.forEach(docSnap=>{
    const i = docSnap.data();
    const date = i.date?.toDate().toLocaleString() || "N/A";
    interactionsTable.innerHTML += `
      <tr>
        <td data-label="Date">${date}</td>
        <td data-label="Type">${i.type||""}</td>
        <td data-label="Phone">${i.phoneUsed||""}</td>
        <td data-label="Notes">${i.notes||""}</td>
      </tr>
    `;
  });
}

// Initial load
loadClients();
</script>

</body>
</html>
